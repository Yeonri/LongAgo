<template>
  <div class="w-full h-full grid grid-cols-5 grid-rows-2">
    <div class="h-full row-span-2 grid grid-rows-3">
      <!-- <template v-for="(user, index) in props.participants" :key="user.id"> -->
      <template v-for="(order, index) in props.inGameOrder" :key="order">
        <div
          class="flex flex-col justify-center items-center relative"
          v-if="index % 2 == 0"
        >
          <img :src="props.participants[order].image" class="w-28 h-28 z-10" alt="프로필" />
          <div
            class="rounded-full w-24 h-24 absolute top-10 z-0"
            :class="currTurn === index ? 'sun' : ''"
            >
          </div>
          <div
            class="absolute bg-[#aee8ff] w-[120px] min-h-[30px] rounded-lg top-[20px] right-[-70px] after:absolute after:bottom-0 after:left-[10%] after:border-[15px] after:border-transparent after:border-b-0 after:border-l-0 after:mb-[-10px] after:border-t-[#aee8ff] after:w-0 after:h-0 pl-3 hidden"
            :class="'speech-bubble' + index"
          >
            <p></p>
          </div>
          <div
            class="absolute bg-[#aee8ff] w-[80px] min-h-[60px] rounded-full bottom-[30px] right-[-20px] after:absolute after:top-0 after:left-[10%] after:border-[20px] after:border-transparent after:border-t-0 after:border-l-0 after:mt-[-10px] after:border-b-[#aee8ff] after:w-0 after:h-0 flex justify-center items-center hidden"
            :class="'emoticon-bubble' + index"
          >
            <img src="" alt="" class="object-scale-down w-10 h-10" />
          </div>
          <div>{{ props.participants[order].name }}</div>
          <p></p>
          <div class="flex">
            <img :src="HeartIcon" alt="하트" />
            <div
              class="rounded-full bg-gray-400 w-5 h-5 text-center leading-[1.25rem] ml-1"
            >
              {{ 4 }}
            </div>
          </div>
        </div>
      </template>
      <template
        v-for="n in maxParticipants - props.participants.length"
        :key="n"
      >
        <div
          class="flex flex-col justify-center items-center"
          v-if="n % 2 == 0"
        >
          <div
            class="rounded-full bg-gray-500 w-24 h-24 border border-black"
          ></div>
          <div>비어 있음</div>
          <div class="h-5"></div>
        </div>
      </template>
    </div>
    <div class="col-span-3 row-span-2 grid grid-rows-5">
      <InGameContent />
      <InGameControl
        @broadcast-message="broadcastMessage"
        @next-turn="nextTurn"
        :myTurn="myTurn"  
        :currTurn="currTurn"
      />
    </div>
    <div class="h-full row-span-2 grid grid-rows-3">
      <template v-for="(order, index) in props.inGameOrder" :key="index">
        <div
          class="flex flex-col justify-center items-center relative"
          v-if="index % 2 != 0"
        >
          <img :src="props.participants[order].image" class="w-28 h-28 z-10" alt="프로필" />
          <div
            class="rounded-full w-24 h-24 absolute top-10 z-0"
            :class="currTurn === index ? 'sun' : ''"
            >
          </div>
          <div
            class="absolute bg-[#aee8ff] w-[120px] h-[30px] rounded-lg top-[20px] left-[-70px] after:absolute after:bottom-0 after:right-[10%] after:border-[15px] after:border-transparent after:border-b-0 after:border-r-0 after:mb-[-10px] after:border-t-[#aee8ff] after:w-0 after:h-0 pl-3 hidden"
            :class="'speech-bubble' + index"
          >
            <p></p>
          </div>
          <div
            class="absolute bg-[#aee8ff] w-[80px] min-h-[60px] rounded-full bottom-[30px] left-[-20px] after:absolute after:top-0 after:right-[10%] after:border-[20px] after:border-transparent after:border-t-0 after:border-r-0 after:mt-[-10px] after:border-b-[#aee8ff] after:w-0 after:h-0 flex justify-center items-center hidden"
            :class="'emoticon-bubble' + index"
          >
            <img src="" alt="" class="object-scale-down w-10 h-10" />
          </div>
          <div>{{ props.participants[order].name }}</div>
          <p></p>
          <div class="flex">
            <img :src="HeartIcon" alt="하트" />
            <div
              class="rounded-full bg-gray-400 w-5 h-5 text-center leading-[1.25rem] ml-1"
            >
              {{ 4 }}
            </div>
          </div>
        </div>
      </template>
      <template
        v-for="n in maxParticipants - props.participants.length"
        :key="n"
      >
        <div
          class="flex flex-col justify-center items-center"
          v-if="n % 2 != 0"
        >
          <div
            class="rounded-full bg-gray-500 w-24 h-24 border border-black"
          ></div>
          <div>비어 있음</div>
          <div class="h-5"></div>
        </div>
      </template>
    </div>
    <InGameProgress @next-turn="nextTurn" :roomConfigs="roomConfigs" :inProgress="inProgress" />
    <!-- <InGameVote /> -->
  </div>
</template>

<script setup>
import { onBeforeMount, ref, watch } from "vue";
import { HeartIcon } from "@/assets";
import {
  InGameControl,
  InGameContent,
  InGameProgress,
  InGameVote,
} from "@/components";

const maxParticipants = 6;
const chatTime = ref([
  [undefined, undefined],
  [undefined, undefined],
  [undefined, undefined],
  [undefined, undefined],
  [undefined, undefined],
  [undefined, undefined],
]);

const emit = defineEmits(["broadcastMessage", "gameExit", "nextTurn"]);

const broadcastMessage = (data) => {
  emit("broadcastMessage", data);
};

const nextTurn = (data) => {
  emit("nextTurn", data);
};

const props = defineProps({
  roomConfigs: {
    Type: Object,
  },
  connectedPeers: {
    Type: Array,
  },
  receivedMessages: {
    Type: Array,
  },
  participants: {
    Type: Array,
  },
  inGameOrder: {
    Type: Array,
  },
  currTurn: {
    Type: Number,
  },
  inProgress: {
    Type: Boolean,
  },
  myTurn: {
    Type: Number,
  },
});

watch(
  () => props.receivedMessages,
  () => {
    props.inGameOrder.forEach((order, index) => {
      if (
        props.receivedMessages[props.receivedMessages.length - 1].sender != '시스템' &&
        props.participants[order].name ==
        props.receivedMessages[props.receivedMessages.length - 1].sender
      ) {
        const select = ref();
        let type = 0;
        if (
          props.receivedMessages[props.receivedMessages.length - 1].form ==
          "emoticon"
        ) {
          select.value = document.querySelector(".emoticon-bubble" + index);
          type = 1;
          select.value.firstChild.src =
            props.receivedMessages[props.receivedMessages.length - 1].message;
        } else {
          select.value = document.querySelector(".speech-bubble" + index);
          select.value.firstChild.textContent =
            props.receivedMessages[props.receivedMessages.length - 1].message;
        }
        select.value.classList.remove("hidden");
        clearTimeout(chatTime.value[index][type]);
        chatTime.value[index][type] = setTimeout(() => {
          select.value.classList.add("hidden");
        }, 3000);
      }
    });
  },
  { deep: true },
);

onBeforeMount(() => {
  emit("gameExit");
});
</script>

<style scoped>
@keyframes corona {
  0%,
  100% {
    box-shadow:
      0 0 6px 3px rgba(102, 204, 255, 0.8),
      0 0 12px 6px rgba(0, 102, 255, 0.6),
      0 0 24px 12px rgba(0, 51, 204, 0.4);
  }
  50% {
    box-shadow:
      0 0 8px 4px rgba(102, 204, 255, 0.9),
      0 0 15px 12px rgba(0, 102, 255, 0.7),
      0 0 28px 14px rgba(0, 51, 204, 0.5);
  }
}

.sun {
  animation: corona 2s infinite alternate ease-in-out;
}
</style>
